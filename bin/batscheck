#!/bin/bash
args=()
tmps=()
orgs=()
trap 'for t in "${orgs[@]}";do [[ -f "$t" ]] && rm -f "$f"; done' HUP INT QUIT TERM
for a in "$@"; do
  if [[ $a == *.bats && -f $a ]]; then
    t=$(mktemp)
    [[ -f "$t" ]] || exit 1
    tmps+=("$t")
    orgs+=("$a")
    # convert @test line to dummy function definition
    perl -pe's/^\@test\s.*\{$/"at_test_$. () {"/e' <"$a" >"$t"
    a=$t
  fi
  args+=("$a")
done

# revert filename, filter in stderr
exec 2> >(
while read -r line; do
  for i in "${!tmps[@]}"; do
    t=${tmps[$i]}
    o=${orgs[$i]}
    [[ $line == "$t:"* ]] && line="$o${line#$t}"
  done
  printf "%s\n" "$line"
done>&2
)
bash "${args[@]}"
